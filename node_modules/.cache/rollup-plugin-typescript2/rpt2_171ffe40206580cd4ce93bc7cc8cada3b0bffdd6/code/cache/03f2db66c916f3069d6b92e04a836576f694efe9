{"code":"import { isArray, isIntegerKey } from '@vue/shared/src';\r\nexport function effect(fn, options = {}) {\r\n    // 我需要让这个effect变成响应的effect，可以做到数据变化重新执行\r\n    const effect = createReactiveEffect(fn, options);\r\n    if (!options.lazy) {\r\n        // 默认的effect会先执行\r\n        effect(); // 响应式的effect默认会先执行一次\r\n    }\r\n    return effect;\r\n}\r\nlet uid = 0;\r\nlet activeEffect; // 存储当前的effect\r\nconst effectStack = [];\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function reactiveEffect() {\r\n        if (!effectStack.includes(effect)) {\r\n            // 保证effect没有加入到effectStack中\r\n            try {\r\n                effectStack.push(effect);\r\n                activeEffect = effect;\r\n                return fn(); // 函数执行时会取值  会执行get方法\r\n            }\r\n            finally {\r\n                effectStack.pop();\r\n                activeEffect = effectStack[effectStack.length - 1];\r\n            }\r\n        }\r\n    };\r\n    effect.id = uid++; // 制作一个effect标识 用于区分effect\r\n    effect._isEffect = true; // 用于标识这个是响应式effect\r\n    effect.raw = fn; // 保留effect对应的原函数\r\n    effect.options = options; // 在effect上保存用户的属性\r\n    return effect;\r\n}\r\n// 让某个对象中的属性 收集当前他对应的effect函数\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type, key) {\r\n    // 可以拿到当前的effect\r\n    //  activeEffect 当前正在运行的effect\r\n    if (activeEffect === undefined) {\r\n        // 此属性不用收集依赖，因为没在effect中使用\r\n        return;\r\n    }\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map()));\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set()));\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect);\r\n    }\r\n}\r\n// 找属性对应的effect 让其执行 （数组、对象）\r\nexport function trigger(target, type, key, newValue, oldValue) {\r\n    // 如果这个属性没有收集过effect，那不需要做任何操作\r\n    const depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return; // 只是改了属性 这个属性没有在effect中使用\r\n    const effects = new Set(); // 这里对effect去重了\r\n    const add = (effectsToAdd) => {\r\n        // 如果同时有多个 依赖的effect是同一个 还用set做了一个过滤\r\n        if (effectsToAdd) {\r\n            effectsToAdd.forEach((effect) => effects.add(effect));\r\n        }\r\n    };\r\n    // 我要将所有的 要执行的effect 全部存到一个新的集合中，最终一起执行\r\n    // 1. 看修改的是不是数组的长度 因为改长度影响比较大 小于依赖收集的长度 要触发重新渲染\r\n    // 2. 如果调用了push方法 或者其他新增数组的方法(必须能改变长度的方法) 也要触发更新\r\n    if (key === 'length' && isArray(target)) {\r\n        // 如果对应的长度 有依赖收集需要更新\r\n        depsMap.forEach((dep, key) => {\r\n            if (key === 'length' || key > newValue) {\r\n                // 如果更改的长度 小于收集的索引，那么这个索引也需要触发effect重新执行\r\n                add(dep);\r\n            }\r\n        });\r\n    }\r\n    else {\r\n        // 可能是对象\r\n        if (key !== undefined) {\r\n            // 这里肯定是修改， 不能是新增\r\n            add(depsMap.get(key)); // 如果是新增\r\n        }\r\n        // 如果修改数组中的 某一个索引 怎么办？\r\n        switch (type // 如果添加了一个索引就触发长度的更新\r\n        ) {\r\n            case 0 /* TriggerOrTypes.ADD */:\r\n                if (isArray(target) && isIntegerKey(key)) {\r\n                    add(depsMap.get('length'));\r\n                }\r\n        }\r\n    }\r\n    effects.forEach((effect) => {\r\n        if (effect.options.scheduler) {\r\n            effect.options.scheduler(effect); // 如果有自己提供的scheduler 则执行scheduler逻辑\r\n        }\r\n        else {\r\n            effect();\r\n        }\r\n    });\r\n}\r\n// weakMap {name:'pf',age:12}  (map) =>{name => set(effect),age => set(effect)}\r\n// {name:'pf',age:12} => name => [effect effect]\r\n// 函数调用是一个栈型结构\r\n// effect(()=>{ // effect1   [effect1]\r\n//     state.name -> effect1\r\n//     effect(()=>{ // effect2\r\n//         state.age -> effect2\r\n//     })\r\n//     state.address -> effect1\r\n// })\r\n// 一个属性对应多个effect 一个effect还可以对应多个属性\r\n//  target key = [effect,effect]\r\n//# sourceMappingURL=effect.js.map","references":["/Users/pangjianfeng/code/pf-vue3-source/vue3-render/packages/shared/src/index.ts","/Users/pangjianfeng/code/pf-vue3-source/vue3-render/packages/reactivity/src/operators.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
